name: Build

on:
  push:
    branches: [main]
    paths:
      - "Dockerfile"
      - ".github/workflows/build.yml"
      - "renovate.json"
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:
    inputs:
      force_push:
        description: "Push images even on non-main builds"
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  security-events: write
  attestations: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: inherent-design/cnpg-timescale
  PG_MAJOR: "18"

jobs:
  build:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-qemu-action@v3

      - uses: useblacksmith/setup-docker-builder@v1

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ env.PG_MAJOR }}
            type=schedule,pattern=${{ env.PG_MAJOR }}-{{date 'YYYYMMDD'}}
            type=sha,prefix=${{ env.PG_MAJOR }}-

      - id: build-test
        uses: useblacksmith/build-push-action@v2
        with:
          context: .
          platforms: linux/amd64
          load: true
          tags: ${{ env.IMAGE_NAME }}:smoke-test
          build-args: |
            PG_MAJOR=${{ env.PG_MAJOR }}

      - name: Smoke test
        run: |
          docker run --rm --entrypoint sh ${{ env.IMAGE_NAME }}:smoke-test -c '
            PG=18
            SO=$(find /usr/lib/postgresql/$PG/lib -name "timescaledb-*.so" | head -1)
            if [ -z "$SO" ]; then echo "FAIL: timescaledb .so not found"; exit 1; fi
            echo "Found: $SO"
            for ext in timescaledb vector; do
              CTRL="/usr/share/postgresql/$PG/extension/${ext}.control"
              if [ ! -f "$CTRL" ]; then echo "FAIL: $CTRL not found"; exit 1; fi
              VER=$(grep default_version "$CTRL" | cut -d= -f2 | tr -d " '"'"'")
              echo "Found: $ext $VER"
            done
            for bin in barman-cloud-backup barman-cloud-wal-archive barman-cloud-check-wal-archive barman-cloud-wal-restore barman-cloud-restore; do
              if ! command -v "$bin" >/dev/null 2>&1; then echo "FAIL: $bin not found"; exit 1; fi
              echo "Found: $bin"
            done
            echo "All extensions and backup tools validated"
          '

      - name: Scan image
        id: trivy
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:smoke-test
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH

      - uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.trivy.conclusion != 'skipped'
        with:
          sarif_file: trivy-results.sarif

      - id: push
        uses: useblacksmith/build-push-action@v2
        if: github.ref == 'refs/heads/main' || github.event.inputs.force_push == 'true'
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            PG_MAJOR=${{ env.PG_MAJOR }}
          provenance: mode=max
          sbom: true

      - uses: actions/attest-build-provenance@v3
        if: steps.push.outcome == 'success'
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

      - name: Summary
        if: steps.push.outcome == 'success'
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.PG_MAJOR }}" >> $GITHUB_STEP_SUMMARY
          echo "- Digest: ${{ steps.push.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "- Platforms: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
